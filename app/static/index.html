<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracker Agent â€” Jira Update Automation</title>
  <style>
    :root {
      --bg: #faf9f7;
      --surface: #ffffff;
      --surface-hover: #f5f3f0;
      --border: #e7e5e0;
      --text: #292524;
      --text-muted: #78716c;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #15803d;
      --warning: #b45309;
      --danger: #b91c1c;
      --accent: #6d28d9;
      --radius: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ---- Header ---- */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 { font-size: 20px; font-weight: 600; }
    .header-tabs { display: flex; gap: 4px; }
    .header-tabs button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 14px;
    }
    .header-tabs button.active {
      background: var(--primary);
      color: white;
    }

    /* ---- Controls ---- */
    .controls {
      padding: 20px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .controls label { font-size: 14px; color: var(--text-muted); }
    .controls input[type="text"] {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 14px;
      border-radius: var(--radius);
      font-size: 14px;
      width: 380px;
    }
    .controls input[type="text"]:focus { outline: none; border-color: var(--primary); }

    .btn {
      border: none;
      padding: 8px 18px;
      border-radius: var(--radius);
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--surface-hover); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #166534; }
    .btn-danger { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-danger:hover { background: var(--surface-hover); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .spacer { flex: 1; }

    /* ---- Status bar ---- */
    .status-bar {
      padding: 0 32px 12px;
      font-size: 13px;
      color: var(--text-muted);
      min-height: 20px;
    }
    .status-bar .error { color: var(--danger); }
    .status-bar .success { color: var(--success); }
    .status-bar .warning { color: var(--warning); }

    /* ---- Table ---- */
    .table-wrap {
      padding: 0 32px 32px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead th {
      text-align: left;
      padding: 10px 14px;
      background: var(--surface);
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid var(--border); }
    tbody tr:hover { background: var(--surface-hover); }
    tbody td {
      padding: 10px 14px;
      vertical-align: middle;
    }
    /* Indent tracks and milestones */
    tr.row-workstream td:first-child { font-weight: 600; color: var(--accent); }
    tr.row-track td:first-child { padding-left: 28px; font-weight: 500; }
    tr.row-milestone td:first-child { padding-left: 48px; }

    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-on-track { background: #dcfce7; color: #15803d; }
    .badge-at-risk { background: #fef3c7; color: #92400e; }
    .badge-off-track { background: #fee2e2; color: #b91c1c; }
    .badge-complete { background: #dbeafe; color: #1d4ed8; }
    .badge-default { background: #f3f4f6; color: #6b7280; }

    .notes-link {
      color: var(--primary);
      text-decoration: none;
      font-size: 13px;
    }
    .notes-link:hover { text-decoration: underline; }

    .preview-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .preview-btn:hover { border-color: var(--primary); color: var(--primary); }
    .preview-btn.has-preview { border-color: var(--success); color: var(--success); }
    .preview-btn svg { width: 16px; height: 16px; }

    /* ---- Modal overlay ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 680px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(0,0,0,0.12);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h2 { font-size: 16px; font-weight: 600; }
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }
    .modal-close:hover { color: var(--text); }

    .modal-body { padding: 24px; }

    .field-group { margin-bottom: 20px; }
    .field-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .field-group textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
      padding: 12px;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      min-height: 80px;
    }
    .field-group textarea:focus { outline: none; border-color: var(--primary); }

    .summary-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      font-size: 14px;
      line-height: 1.6;
    }
    .summary-box .date-tag {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .posting-status {
      font-size: 13px;
      padding: 8px 0;
    }

    /* ---- Spinner ---- */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- Empty state ---- */
    .empty-state {
      text-align: center;
      padding: 60px 32px;
      color: var(--text-muted);
    }
    .empty-state p { margin-top: 8px; font-size: 14px; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>Jira Update Automation</h1>
    <div class="header-tabs">
      <button class="active">Dashboard</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <label for="sheetId">Sheet ID</label>
    <input type="text" id="sheetId" placeholder="Paste Google Sheet ID here..." />
    <button class="btn btn-secondary" id="btnRefresh" onclick="loadSheet()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
      Refresh
    </button>
    <div class="spacer"></div>
    <button class="btn btn-primary" id="btnGenerate" onclick="runUpdates()" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      Run Updates Now
    </button>
  </div>

  <!-- Status bar -->
  <div class="status-bar" id="statusBar"></div>

  <!-- Table -->
  <div class="table-wrap">
    <div class="empty-state" id="emptyState">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
      <p>Enter a Sheet ID above and click Refresh to load tracker data.</p>
    </div>
    <table id="dataTable" style="display:none">
      <thead>
        <tr>
          <th>Description</th>
          <th>Work Type</th>
          <th>Status</th>
          <th>Target Date</th>
          <th>Owner</th>
          <th>Jira ID</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModalOverlay(event)">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Update Preview</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <label>Jira Update</label>
          <textarea id="fieldJiraUpdate" rows="10"></textarea>
        </div>
        <div class="field-group">
          <label>Leadership Update</label>
          <div class="summary-box">
            <div class="date-tag" id="summaryDate"></div>
            <textarea id="fieldLeadership" rows="2" style="border:none;background:transparent;padding:0;width:100%;color:var(--text);font-family:inherit;font-size:14px;resize:vertical;min-height:40px;"></textarea>
          </div>
        </div>
        <div class="posting-status" id="postingStatus"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" id="btnPostToJira" onclick="postToJira()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Post to Jira
        </button>
      </div>
    </div>
  </div>

<script>
const API = window.location.origin;

// In-memory state
let sheetRows = [];          // raw rows from the sheet
let generatedUpdates = {};   // keyed by jira_id -> JiraUpdate object
let currentMilestone = null; // the milestone open in the modal

// ---- Sheet loading ----

async function loadSheet() {
  const sheetId = document.getElementById('sheetId').value.trim();
  if (!sheetId) return setStatus('Enter a Sheet ID first.', 'error');

  setStatus('Loading sheet data...');
  disableControls(true);

  try {
    const res = await fetch(`${API}/read-sheet/${encodeURIComponent(sheetId)}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || res.statusText);
    }
    const data = await res.json();
    sheetRows = data.rows;
    generatedUpdates = {};
    renderTable();
    document.getElementById('btnGenerate').disabled = false;
    setStatus(`Loaded ${sheetRows.length} rows.`, 'success');
  } catch (e) {
    setStatus(e.message, 'error');
  } finally {
    disableControls(false);
  }
}

// ---- Table rendering ----

function renderTable() {
  const tbody = document.getElementById('tableBody');
  const table = document.getElementById('dataTable');
  const empty = document.getElementById('emptyState');

  if (!sheetRows.length) {
    table.style.display = 'none';
    empty.style.display = '';
    return;
  }

  table.style.display = '';
  empty.style.display = 'none';

  tbody.innerHTML = sheetRows.map((row, idx) => {
    const wt = (row['WorkType'] || '').trim();
    const desc = row['Description'] || '';
    const status = (row['Status'] || '').trim();
    const target = row['Target Date'] || '';
    const owner = row['Milestone Owner'] || '';
    const jiraId = (row['Jira ID'] || '').trim();
    const notes = (row['Notes'] || '').trim();

    const rowClass = wt === 'Workstream' ? 'row-workstream'
                   : wt === 'Track' ? 'row-track'
                   : wt === 'Milestone' ? 'row-milestone' : '';

    const statusBadge = status ? `<span class="badge ${badgeClass(status)}">${status}</span>` : '';
    const notesLink = notes ? `<a class="notes-link" href="${notes}" target="_blank" rel="noopener">View Doc</a>` : '';

    const hasPreview = generatedUpdates[jiraId];
    const previewBtn = (wt === 'Milestone' && jiraId)
      ? `<button class="preview-btn ${hasPreview ? 'has-preview' : ''}" title="Preview update" onclick="openPreview(${idx})">
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
             <circle cx="12" cy="12" r="3"/>
           </svg>
         </button>`
      : '';

    return `<tr class="${rowClass}" data-idx="${idx}">
      <td>${desc}</td>
      <td>${wt}</td>
      <td>${statusBadge}</td>
      <td>${target}</td>
      <td>${owner}</td>
      <td>${jiraId}</td>
      <td>${notesLink}</td>
      <td>${previewBtn}</td>
    </tr>`;
  }).join('');
}

function badgeClass(status) {
  const s = status.toLowerCase();
  if (s.includes('on track') || s === 'on-track') return 'badge-on-track';
  if (s.includes('at risk') || s === 'at-risk') return 'badge-at-risk';
  if (s.includes('off track') || s.includes('delayed') || s === 'off-track') return 'badge-off-track';
  if (s.includes('complete') || s.includes('done')) return 'badge-complete';
  return 'badge-default';
}

// ---- Generate previews ----

async function runUpdates() {
  const sheetId = document.getElementById('sheetId').value.trim();
  if (!sheetId) return;

  setStatus('<span class="spinner"></span> Generating AI previews... this may take a moment.');
  disableControls(true);

  try {
    const res = await fetch(`${API}/generate-preview`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sheet_id: sheetId }),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || res.statusText);
    }

    const data = await res.json();

    // Index generated updates by jira_id
    generatedUpdates = {};
    const errors = [];
    for (const result of (data.results || [])) {
      if (result.error) {
        errors.push(`${result.workstream || ''} / ${result.track || ''}: ${result.error}`);
      }
      for (const update of (result.updates || [])) {
        generatedUpdates[update.jira_id] = {
          ...update,
          workstream: result.workstream,
          track: result.track,
        };
      }
    }

    renderTable();
    const count = Object.keys(generatedUpdates).length;
    if (errors.length && count === 0) {
      setStatus(`Error generating previews: ${errors[0]}`, 'error');
    } else if (errors.length) {
      setStatus(`Generated previews for ${count} milestone(s), but ${errors.length} track(s) had errors. Click the eye icons to review.`, 'warning');
    } else {
      setStatus(`Generated previews for ${count} milestone(s). Click the eye icons to review.`, 'success');
    }
  } catch (e) {
    setStatus(e.message, 'error');
  } finally {
    disableControls(false);
  }
}

// ---- Preview modal ----

function findTrackName(rowIdx) {
  // Walk backwards from milestone row to find the parent Track row
  for (let i = rowIdx - 1; i >= 0; i--) {
    if ((sheetRows[i]['WorkType'] || '').trim() === 'Track') {
      return (sheetRows[i]['Description'] || '').trim();
    }
  }
  return null;
}

async function generateForTrack(trackName) {
  const sheetId = document.getElementById('sheetId').value.trim();

  const res = await fetch(`${API}/generate-preview`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sheet_id: sheetId, track_name: trackName }),
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.detail || res.statusText);
  }

  const data = await res.json();

  // Index all updates from this track into the cache
  for (const result of (data.results || [])) {
    for (const update of (result.updates || [])) {
      generatedUpdates[update.jira_id] = {
        ...update,
        workstream: result.workstream,
        track: result.track,
      };
    }
  }

  renderTable();
}

async function openPreview(rowIdx) {
  const row = sheetRows[rowIdx];
  const jiraId = (row['Jira ID'] || '').trim();
  const name = (row['Description'] || '').trim();

  // If no preview cached yet, generate on demand for this track
  if (!generatedUpdates[jiraId]) {
    const trackName = findTrackName(rowIdx);
    if (!trackName) {
      setStatus(`Could not determine parent track for ${jiraId}.`, 'error');
      return;
    }

    // Show loading state on the button
    const btn = document.querySelector(`tr[data-idx="${rowIdx}"] .preview-btn`);
    if (btn) btn.innerHTML = '<span class="spinner"></span>';

    setStatus(`<span class="spinner"></span> Generating preview for track "${trackName}"...`);
    try {
      await generateForTrack(trackName);
    } catch (e) {
      setStatus(e.message, 'error');
      renderTable();
      return;
    }
    setStatus('Preview ready.', 'success');
  }

  const update = generatedUpdates[jiraId];
  if (!update) {
    setStatus(`No update was generated for ${jiraId}. The LLM may not have returned data for this milestone.`, 'error');
    return;
  }

  currentMilestone = { rowIdx, jiraId, name, update };

  document.getElementById('modalTitle').textContent = `Update Preview: ${jiraId} \u2014 ${name}`;

  // Combine progress, changes, and next steps into one Jira update
  let jiraUpdate = '';
  if (update.progress_summary && update.progress_summary.length) {
    jiraUpdate += 'Progress Summary:\n' + update.progress_summary.map(b => `\u2022 ${b}`).join('\n') + '\n\n';
  }
  if (update.recent_changes && update.recent_changes.length) {
    jiraUpdate += 'Recent Changes:\n' + update.recent_changes.map(b => `\u2022 ${b}`).join('\n') + '\n\n';
  }
  if (update.next_steps && update.next_steps.length) {
    jiraUpdate += 'Next Steps:\n' + update.next_steps.map(b => `\u2022 ${b}`).join('\n');
  }
  document.getElementById('fieldJiraUpdate').value = jiraUpdate.trim();

  document.getElementById('summaryDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('fieldLeadership').value = update.leadership_summary || '';
  document.getElementById('postingStatus').innerHTML = '';
  document.getElementById('btnPostToJira').disabled = false;

  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  currentMilestone = null;
}

function closeModalOverlay(e) {
  if (e.target === e.currentTarget) closeModal();
}

// ---- Post to Jira ----

async function postToJira() {
  if (!currentMilestone) return;

  const { jiraId } = currentMilestone;
  const btn = document.getElementById('btnPostToJira');
  const statusEl = document.getElementById('postingStatus');

  // Build the comment from the editable fields
  const jiraUpdate = document.getElementById('fieldJiraUpdate').value.trim();
  const leadership = document.getElementById('fieldLeadership').value.trim();

  let comment = jiraUpdate;
  if (leadership) comment += '\n\nLeadership Summary:\n' + leadership;

  btn.disabled = true;
  statusEl.innerHTML = '<span class="spinner"></span> Posting to Jira...';

  try {
    const res = await fetch(`${API}/post-to-jira`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jira_id: jiraId, comment: comment.trim() }),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || res.statusText);
    }

    statusEl.innerHTML = '<span style="color:var(--success)">Posted successfully!</span>';

    // Also update the sheet summary if we have a sheet ID
    const sheetId = document.getElementById('sheetId').value.trim();
    if (sheetId && leadership && currentMilestone.update.track) {
      await fetch(`${API}/update-sheet-summary`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sheet_id: sheetId,
          track_name: currentMilestone.update.track,
          leadership_summary: leadership,
        }),
      });
      statusEl.innerHTML = '<span style="color:var(--success)">Posted to Jira & updated sheet summary!</span>';
    }

    // Update in-memory state with edits
    generatedUpdates[jiraId].leadership_summary = leadership;

  } catch (e) {
    statusEl.innerHTML = `<span style="color:var(--danger)">Error: ${e.message}</span>`;
    btn.disabled = false;
  }
}

// ---- Helpers ----

function bulletsToText(arr) {
  if (!arr || !arr.length) return '';
  return arr.map(b => `\u2022 ${b}`).join('\n');
}

function textToBullets(text) {
  return text
    .split('\n')
    .map(line => line.replace(/^[\u2022\-\*]\s*/, '').trim())
    .filter(Boolean);
}

function setStatus(msg, type) {
  const el = document.getElementById('statusBar');
  el.innerHTML = type ? `<span class="${type}">${msg}</span>` : msg;
}

function disableControls(disabled) {
  document.getElementById('btnRefresh').disabled = disabled;
  document.getElementById('btnGenerate').disabled = disabled;
  document.getElementById('sheetId').disabled = disabled;
}
</script>
</body>
</html>
